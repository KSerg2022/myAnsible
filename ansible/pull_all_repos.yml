---
- name: Pull all git repos under configured base_dirs (excluding configured excludes)
  hosts: localhost
  gather_facts: false
  vars:
    config_file_raw: "{{ lookup('env', 'PULL_CONFIG') | default('config.pull.json', true) }}"
  tasks:
    - name: Build config file candidate list
      ansible.builtin.set_fact:
        config_file_candidates: >-
          {{
            (config_file_raw is match('^/'))
            | ternary([config_file_raw], [config_file_raw, (playbook_dir ~ '/../' ~ config_file_raw)])
          }}

    - name: Check config file candidates
      ansible.builtin.stat:
        path: "{{ item }}"
      loop: "{{ config_file_candidates }}"
      register: cfg_stat

    - name: Select config file path
      ansible.builtin.set_fact:
        config_file: "{{ (cfg_stat.results | selectattr('stat.exists') | map(attribute='item') | list | first) | default('') }}"

    - name: Fail if config missing
      ansible.builtin.fail:
        msg: "Config file not found. Tried: {{ config_file_candidates | join(', ') }}"
      when: config_file == ''

    - name: Load pull config
      ansible.builtin.include_vars:
        file: "{{ config_file }}"
        name: pull_cfg

    - name: Read defaults from config
      ansible.builtin.set_fact:
        cfg_base_dirs: "{{ pull_cfg.base_dirs | default(['/home/ksv/solongoProjects']) }}"
        cfg_exclude_dirs: "{{ pull_cfg.exclude_dirs | default(['/home/ksv/solongoProjects/ansibleLocal']) }}"
        cfg_max_depth: "{{ pull_cfg.max_depth | default(none) }}"
        cfg_branch_priority: "{{ pull_cfg.branch_priority | default(['stage', 'prod', 'Prod', 'main', 'master']) }}"
        cfg_prefer_current: "{{ pull_cfg.prefer_current | default(true) }}"
        cfg_allow_remote_branches: "{{ pull_cfg.allow_remote_branches | default(true) }}"
        cfg_remote_name: "{{ pull_cfg.remote_name | default('origin') }}"
        cfg_pull_ff_only: "{{ pull_cfg.pull_ff_only | default(true) }}"
        cfg_skip_dirty: "{{ pull_cfg.skip_dirty | default(true) }}"
        cfg_dry_run: "{{ pull_cfg.dry_run | default(false) }}"

    - name: Apply defaults unless overridden (extra vars)
      ansible.builtin.set_fact:
        base_dirs: "{{ cfg_base_dirs }}"
      when: base_dirs is not defined

    - name: Apply defaults unless overridden (extra vars)
      ansible.builtin.set_fact:
        exclude_dirs: "{{ cfg_exclude_dirs }}"
      when: exclude_dirs is not defined

    - name: Apply defaults unless overridden (extra vars)
      ansible.builtin.set_fact:
        max_depth: "{{ cfg_max_depth }}"
      when: max_depth is not defined

    - name: Apply defaults unless overridden (extra vars)
      ansible.builtin.set_fact:
        branch_priority: "{{ cfg_branch_priority }}"
      when: branch_priority is not defined

    - name: Apply defaults unless overridden (extra vars)
      ansible.builtin.set_fact:
        prefer_current: "{{ cfg_prefer_current }}"
      when: prefer_current is not defined

    - name: Apply defaults unless overridden (extra vars)
      ansible.builtin.set_fact:
        allow_remote_branches: "{{ cfg_allow_remote_branches }}"
      when: allow_remote_branches is not defined

    - name: Apply defaults unless overridden (extra vars)
      ansible.builtin.set_fact:
        remote_name: "{{ cfg_remote_name }}"
      when: remote_name is not defined

    - name: Apply defaults unless overridden (extra vars)
      ansible.builtin.set_fact:
        pull_ff_only: "{{ cfg_pull_ff_only }}"
      when: pull_ff_only is not defined

    - name: Apply defaults unless overridden (extra vars)
      ansible.builtin.set_fact:
        skip_dirty: "{{ cfg_skip_dirty }}"
      when: skip_dirty is not defined

    - name: Apply defaults unless overridden (extra vars)
      ansible.builtin.set_fact:
        dry_run: "{{ cfg_dry_run }}"
      when: dry_run is not defined

    - name: Find git directories
      ansible.builtin.find:
        paths: "{{ item }}"
        patterns: ".git"
        file_type: directory
        hidden: true
        recurse: true
        depth: "{{ (max_depth is none) | ternary(omit, (max_depth | int) + 1) }}"
      loop: "{{ base_dirs }}"
      register: git_dirs

    - name: Flatten git dirs list
      ansible.builtin.set_fact:
        git_dirs_all: "{{ git_dirs.results | map(attribute='files') | list | flatten | default([]) }}"

    - name: Build repo list (parent dirs of .git)
      ansible.builtin.set_fact:
        repo_dirs_raw: >-
          {{
            git_dirs_all
            | map(attribute='path')
            | map('dirname')
            | unique
            | list
          }}

    - name: Build exclude regex
      ansible.builtin.set_fact:
        exclude_regex: >-
          {{
            (exclude_dirs | length > 0)
            | ternary('^(' + (exclude_dirs | map('regex_escape') | join('|')) + ')(/|$)', '')
          }}

    - name: Apply excludes
      ansible.builtin.set_fact:
        repo_dirs: >-
          {{
            (repo_dirs_raw | reject('regex', exclude_regex) | list)
            if exclude_regex else repo_dirs_raw
          }}

    - name: Check dirty repos
      ansible.builtin.command:
        cmd: git status --porcelain
        chdir: "{{ item }}"
      loop: "{{ repo_dirs }}"
      register: git_status_results
      changed_when: false
      failed_when: false

    - name: Init dirty repo info
      ansible.builtin.set_fact:
        dirty_repo_info: []

    - name: Collect dirty repo info (status failed)
      ansible.builtin.set_fact:
        dirty_repo_info: >-
          {{
            dirty_repo_info + [
              {
                'path': item.item,
                'reason': 'status_failed',
                'details': (item.stderr | default(''))
              }
            ]
          }}
      loop: "{{ git_status_results.results }}"
      when: item.rc != 0

    - name: Collect dirty repo info (working tree dirty)
      ansible.builtin.set_fact:
        dirty_repo_info: >-
          {{
            dirty_repo_info + [
              {
                'path': item.item,
                'reason': 'working_tree_dirty',
                'details': (item.stdout | default(''))
              }
            ]
          }}
      loop: "{{ git_status_results.results }}"
      when: item.rc == 0 and (item.stdout | default('')) != ''

    - name: Build dirty/clean repo lists
      ansible.builtin.set_fact:
        dirty_repos: "{{ dirty_repo_info | map(attribute='path') | list | unique }}"

    - name: Build clean repo list
      ansible.builtin.set_fact:
        clean_repos: "{{ repo_dirs | difference(dirty_repos | default([])) }}"

    - name: Show dirty repo info
      ansible.builtin.debug:
        msg: >-
          {{
            (skip_dirty | bool)
            | ternary('Skipping dirty repo: ', 'Dirty repo (will proceed): ')
          }}{{ item.path }} reason={{ item.reason }} details={{ item.details | default('') }}
      loop: "{{ dirty_repo_info }}"
      when: dirty_repo_info | length > 0

    - name: Select repos for actions
      ansible.builtin.set_fact:
        repo_dirs_for_actions: "{{ (skip_dirty | bool) | ternary(clean_repos, repo_dirs) }}"

    - name: Fetch remote refs (prune)
      ansible.builtin.command:
        argv:
          - git
          - fetch
          - --prune
          - "{{ remote_name }}"
        chdir: "{{ item }}"
      loop: "{{ repo_dirs_for_actions }}"
      register: git_fetch_results
      failed_when: false
      when: not (dry_run | bool)

    - name: Show fetch failures (details)
      ansible.builtin.debug:
        msg: "{{ item.item }} rc={{ item.rc }} stdout={{ item.stdout | default('') }} stderr={{ item.stderr | default('') }}"
      loop: "{{ git_fetch_results.results | default([]) | selectattr('rc', 'ne', 0) | list }}"
      when: not (dry_run | bool)

    - name: Show fetch failures (summary)
      ansible.builtin.debug:
        msg: "{{ git_fetch_results.results | selectattr('rc', 'ne', 0) | map(attribute='item') | list }}"
      when: not (dry_run | bool) and (git_fetch_results.results | default([]) | selectattr('rc', 'ne', 0) | list | length > 0)

    - name: Select branch (configurable) and switch if needed
      ansible.builtin.command:
        argv:
          - "{{ playbook_dir }}/scripts/select_branch.sh"
          - "{{ item }}"
      environment:
        BRANCH_PRIORITY: "{{ branch_priority | join(' ') }}"
        PREFER_CURRENT: "{{ prefer_current | bool | ternary('1', '0') }}"
        ALLOW_REMOTE_BRANCHES: "{{ allow_remote_branches | bool | ternary('1', '0') }}"
        REMOTE_NAME: "{{ remote_name }}"
        PULL_FF_ONLY: "{{ pull_ff_only | bool | ternary('1', '0') }}"
      loop: "{{ repo_dirs_for_actions }}"
      register: branch_switch_results
      failed_when: false
      when: not (dry_run | bool)

    - name: Show branch switch failures (details)
      ansible.builtin.debug:
        msg: "{{ item.item }} rc={{ item.rc }} stdout={{ item.stdout | default('') }} stderr={{ item.stderr | default('') }}"
      loop: "{{ branch_switch_results.results | default([]) | selectattr('rc', 'ne', 0) | list }}"
      when: not (dry_run | bool)

    - name: Show branch switch failures (summary)
      ansible.builtin.debug:
        msg: "{{ branch_switch_results.results | selectattr('rc', 'ne', 0) | map(attribute='item') | list }}"
      when: not (dry_run | bool) and (branch_switch_results.results | default([]) | selectattr('rc', 'ne', 0) | list | length > 0)

    - name: Build repo -> branch map
      ansible.builtin.set_fact:
        repo_branch_map: "{{ repo_branch_map | default({}) | combine({ item.item: (item.stdout | default('')) }) }}"
      loop: "{{ branch_switch_results.results | default([]) }}"
      when: not (dry_run | bool)

    - name: Build dry-run plan
      ansible.builtin.command:
        argv:
          - "{{ playbook_dir }}/scripts/select_branch.sh"
          - "{{ item }}"
      environment:
        BRANCH_PRIORITY: "{{ branch_priority | join(' ') }}"
        PREFER_CURRENT: "{{ prefer_current | bool | ternary('1', '0') }}"
        ALLOW_REMOTE_BRANCHES: "{{ allow_remote_branches | bool | ternary('1', '0') }}"
        REMOTE_NAME: "{{ remote_name }}"
        PULL_FF_ONLY: "{{ pull_ff_only | bool | ternary('1', '0') }}"
        DRY_RUN: "1"
      loop: "{{ repo_dirs_for_actions }}"
      register: dry_run_plan
      failed_when: false
      when: dry_run | bool

    - name: Show dry-run plan
      ansible.builtin.debug:
        msg: "DRY_RUN: {{ item.item }} -> {{ item.stdout }}"
      loop: "{{ dry_run_plan.results | default([]) }}"
      when: dry_run | bool

    - name: Git pull each repo (ff-only)
      ansible.builtin.command:
        argv: "{{ ['git', 'pull'] + ((pull_ff_only | bool) | ternary(['--ff-only'], [])) }}"
        chdir: "{{ item }}"
      loop: "{{ repo_dirs_for_actions }}"
      register: git_pull_results
      changed_when: >-
        ('Already up to date.' not in (stdout | default(''))) and
        ('Already up-to-date.' not in (stdout | default('')))
      failed_when: false
      when: not (dry_run | bool)

    - name: Show summary
      ansible.builtin.debug:
        msg: "{{ item.item }} -> branch={{ repo_branch_map[item.item] | default('') }} rc={{ item.rc }} stdout={{ item.stdout | default('') }} stderr={{ item.stderr | default('') }}"
      loop: "{{ git_pull_results.results | default([]) }}"
      when: not (dry_run | bool)

    - name: Show git pull failures (summary)
      ansible.builtin.debug:
        msg: "{{ git_pull_results.results | selectattr('rc', 'ne', 0) | map(attribute='item') | list }}"
      when: not (dry_run | bool) and (git_pull_results.results | default([]) | selectattr('rc', 'ne', 0) | list | length > 0)

    - name: Show repos where git pull ran OK
      ansible.builtin.debug:
        msg: "{{ git_pull_results.results | selectattr('rc', 'equalto', 0) | map(attribute='item') | list }}"
      when: not (dry_run | bool)
